<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>低空产业数据服务平台</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="track-style.css"
</head>
<body>
    <div class="platform-container">
        <!-- 顶部导航栏 -->
        <div class="top-navbar">
            <div class="form-group">
                <div class="logo" data-page="index.html">低空产业数据服务平台</div>
                <div class="plat" data-page="platform.html">> 数据平台工具</div>
                <div class="sub-intro">> 航迹大师</div>
            </div>
            <div class="top-right-tools">
                <div class="notification-center">消息/通知中心</div>
                <div class="user-settings">用户设置</div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 左侧参数设置面板 -->
            <div class="left-panel">
                <div class="panel-section">
                    <h3>任务区域选择</h3>
                    <div class="form-group">
                        <label>绘制方式</label>
                        <select id="draw-mode">
                            <option value="rectangle">矩形框选</option>
                            <option value="polygon">多边形框选</option>
                            <option value="circle">圆形框选</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>已选区域面积</label>
                        <input type="text" id="area-size" placeholder="请在地图上框选区域" readonly>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3>航线模式选择</h3>
                    <div class="mode-options">
                        <div class="mode-option" data-mode="1">
                            <input type="radio" name="mode" id="mode1">
                            <div>
                                <label for="mode1">模式1: 环绕航线</label>
                                <div class="mode-info">针对实景三维建模优化，交叉环绕采集建筑物纹理</div>
                            </div>
                        </div>
                        <div class="mode-option" data-mode="2">
                            <input type="radio" name="mode" id="mode2">
                            <div>
                                <label for="mode2">模式2: 立面航线</label>
                                <div class="mode-info">专门用于垂直表面数据采集，保持恒定距离和重叠率</div>
                            </div>
                        </div>
                        <div class="mode-option" data-mode="3">
                            <input type="radio" name="mode" id="mode3">
                            <div>
                                <label for="mode3">模式3: 仿地航线</label>
                                <div class="mode-info">在起伏地形上保持固定高度飞行，保证地面分辨率一致</div>
                            </div>
                        </div>
                        <div class="mode-option" data-mode="4">
                            <input type="radio" name="mode" id="mode4">
                            <div>
                                <label for="mode4">模式4: 雷达航线</label>
                                <div class="mode-info">为无人机搭载激光雷达设计的智能飞行路径规划</div>
                            </div>
                        </div>
                        <div class="mode-option" data-mode="5">
                            <input type="radio" name="mode" id="mode5">
                            <div>
                                <label for="mode5">模式5: 扫摆航线</label>
                                <div class="mode-info">相机在飞行过程中智能摆动，一次飞行采集多角度影像</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3>精度与设备设置</h3>
                    <div class="form-group">
                        <label for="resolution">期望分辨率 (cm/像素)</label>
                        <input type="number" id="resolution" min="1" max="50" value="5">
                    </div>
                    <div class="form-group">
                        <label for="drone-model">无人机型号</label>
                        <select id="drone-model">
                            <option value="dji-mavic3e">大疆 Mavic 3E</option>
                            <option value="dji-m300">大疆 Matrice 300 RTK</option>
                            <option value="dji-m350">大疆 Matrice 350 RTK</option>
                            <option value="dji-m30">大疆 Matrice 30</option>
                            <option value="custom">自定义型号</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="camera-model">相机型号</label>
                        <select id="camera-model">
                            <option value="dji-p1">大疆 P1 (全画幅航测相机)</option>
                            <option value="dji-l1">大疆 L1 (激光雷达)</option>
                            <option value="dji-h20t">大疆 H20T (多传感器)</option>
                            <option value="zenmuse-x5s">禅思 X5S</option>
                            <option value="custom">自定义型号</option>
                        </select>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="generate-btn">生成航线</button>
                </div>
            </div>
            
            <!-- 中央地图工作区 -->
            <div class="main-workspace">
                <div id="map"></div>
                <div class="map-controls">
                    <button id="toggle-btn">进入框选模式</button>
                    <button id="clear-all">清除所选</button>
                    <button id="yes-btn" style="display:none;">完成多边形框选</button>
                </div>
            </div>
            
            <!-- 右侧输出面板 -->
            <div class="right-panel">
                <div class="output-section">
                    <h3>航线输出</h3>
                    <div class="output-item">
                        <h4>飞行计划文件</h4>
                        <p>可直接导入无人机的飞行计划文件，包含航点、动作指令和完整飞行路径</p>
                        <button class="btn btn-secondary">下载 .kmz 文件</button>
                        <button class="btn btn-secondary">下载 .mission 文件</button>
                    </div>
                    
                    <div class="output-item">
                        <h4>可视化预览</h4>
                        <p>在三维形式下动态展示无人机的飞行路径和相机视角，用于检测安全</p>
                        <div class="preview-container">
                            3D 航线预览
                        </div>
                        <button class="btn btn-secondary">打开3D预览</button>
                    </div>
                    
                    <div class="output-item">
                        <h4>任务报告</h4>
                        <p>预计飞行时间、总航程、拍照数量和覆盖面积等信息</p>
                        <div class="task-report">
                            <ul>
                                <li><span class="label">预计飞行时间:</span> <span class="value">--</span></li>
                                <li><span class="label">总航程:</span> <span class="value">--</span></li>
                                <li><span class="label">预计拍照数量:</span> <span class="value">--</span></li>
                                <li><span class="label">覆盖面积:</span> <span class="value">--</span></li>
                                <li><span class="label">最大飞行高度:</span> <span class="value">--</span></li>
                            </ul>
                        </div>
                        <button class="btn btn-secondary">生成详细报告</button>
                    </div>
                    
                    <div class="output-item">
                        <h4>云端同步</h4>
                        <p>将规划好的航线上传到云端，方便团队协作和跨设备调用</p>
                        <button class="btn btn-primary">同步到云端</button>
                        <button class="btn btn-secondary">分享给团队成员</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script>
        
        document.querySelectorAll('.logo').forEach(card => {
            card.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                window.location.href = page;
            });
        });
        
        document.querySelectorAll('.plat').forEach(card => {
            card.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                window.location.href = page;
            });
        });
        
        // 初始化地图
        const map = L.map('map').setView([39.9042, 116.4074], 13); // 默认北京中心
        
        // 添加地图图层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        let isSelectMode = false;
        let mode = 'rectangle'; 
let startLatLng = null;
let tempRect = null;
let tempShape = null;
let isDrawing = false;
let polygonPoints = [];
  const drawnItems = [];
const modeSelect = document.getElementById('draw-mode');
const toggleBtn = document.getElementById('toggle-btn');
const clearBtn = document.getElementById('clear-all');
const finBtn=document.getElementById('yes-btn');
let num=0;
  toggleBtn.addEventListener('click', () => {
    isSelectMode = !isSelectMode;
    toggleBtn.innerText = isSelectMode ? '退出框选模式' : '进入框选模式';

    // 控制地图拖动
    map.dragging[isSelectMode ? 'disable' : 'enable']();
  });

  modeSelect.addEventListener('change', () => {
    mode = modeSelect.value;
    if (mode === 'polygon') {
      // 多边形单击添加点
      document.getElementById('yes-btn').style.display = 'block';
    }
    else document.getElementById('yes-btn').style.display = 'none';
    // 控制地图拖动（框选或点选时禁用）
    /*if (mode === 'none') {
      map.dragging.enable();
    } else {
      map.dragging.disable();
    }*/
  });

  map.on('mousedown', (e) => {
    if (!isSelectMode) return;

    
    document.getElementById('area-size').value='请在地图上框选区域';
    document.getElementById('area-size').style.fontSize='14px';
    document.getElementById('area-size').style.color='#495057';

    if (tempShape){
        map.removeLayer(tempShape);
        tempShape=null;
    }

    if (mode === 'polygon') {
      // 多边形单击添加点
      map.on('click', onPolygonClick);
      return;
    }

    startLatLng = e.latlng;
    isDrawing = true;

    map.on('mousemove', onMouseMove);
  });

  // 鼠标移动
  function onMouseMove(e) {
    if (!isDrawing || !startLatLng) return;

    if (mode === 'rectangle') {
      const bounds = L.latLngBounds(startLatLng, e.latlng);
      if (tempShape) tempShape.setBounds(bounds);
      else tempShape = L.rectangle(bounds, {color: "#0078ff", weight: 2}).addTo(map);
    } else if (mode === 'circle') {
      const radius = map.distance(startLatLng, e.latlng);
      if (tempShape) tempShape.setRadius(radius);
      else tempShape = L.circle(startLatLng, {radius, color: "#0078ff", weight: 2}).addTo(map);
    }
  }

  // 鼠标松开
  map.on('mouseup', (e) => {
    if (!isDrawing) return;
    isDrawing = false;
    map.off('mousemove', onMouseMove);

    if (tempShape) {
      drawnItems.push(tempShape);
      if (mode === 'rectangle') {
        const area = calcRectArea(tempShape.getBounds());
        num=area/1e6;
        document.getElementById('area-size').value = (num).toFixed(2) + ' 平方公里';
    document.getElementById('area-size').style.fontSize='14px';
    document.getElementById('area-size').style.color='#000000';

        //console.log('矩形面积:', area.toFixed(2), 'm²');
      } else if (mode === 'circle') {
        const r = tempShape.getRadius();
        num=Math.PI * r * r/1e6;
        document.getElementById('area-size').value = (num).toFixed(2) + ' 平方公里';
    document.getElementById('area-size').style.fontSize='14px';
    document.getElementById('area-size').style.color='#000000';
        //console.log('圆面积:', (Math.PI * r * r).toFixed(2), 'm²');
      }
    }
  });
function onPolygonClick(e) {
    polygonPoints.push(e.latlng);

    if (polygonPoints.length > 1) {
      if (tempShape) tempShape.setLatLngs(polygonPoints);
      else tempShape = L.polygon(polygonPoints, {color: 'green', weight: 2}).addTo(map);
    }

    // 点击完成
    finBtn.addEventListener('click', () => {
      if (polygonPoints.length > 2) {
        const coords = polygonPoints.map(p => [p.lng, p.lat]);
        const polygon = turf.polygon([[...coords, coords[0]]]);
        const area = turf.area(polygon);
        num=area/1e6;
        document.getElementById('area-size').value = (num).toFixed(2) + ' 平方公里';
        document.getElementById('area-size').style.fontSize='14px';
        document.getElementById('area-size').style.color='#000000';
        //console.log('多边形面积:', area.toFixed(2), 'm²');
      }

      drawnItems.push(tempShape);
      cancelDrawing();
    });
  }

  function cancelDrawing() {
    isDrawing = false;
    startLatLng = null;
    polygonPoints = [];
    map.off('mousemove', onMouseMove);
    map.off('click', onPolygonClick);
  }

  function calcRectArea(bounds) {
    const sw = bounds.getSouthWest();
    const ne = bounds.getNorthEast();
    const width = map.distance([sw.lat, sw.lng], [sw.lat, ne.lng]);
    const height = map.distance([sw.lat, sw.lng], [ne.lat, sw.lng]);
    return width * height;
  }
/*
  // 鼠标按下时记录起点
  map.on('mousedown', function(e) {
    if (!isSelectMode||mode!=='rectangle') return; // 只有框选模式才响应
    isDrawing=true;
    startLatLng = e.latlng;

    document.getElementById('area-size').value='请在地图上框选区域';
    document.getElementById('area-size').style.fontSize='14px';
    document.getElementById('area-size').style.color='#495057';

    // 如果已经有矩形，先删掉
    if (tempRect) {
      map.removeLayer(tempRect);
      tempRect = null;
    }

    // 监听拖动绘制
    map.on('mousemove', onMouseMove);
  });

  // 鼠标移动时绘制矩形
  function onMouseMove(e) {
    if (!isDrawing||!startLatLng) return;

    const bounds = L.latLngBounds(startLatLng, e.latlng);

    // 如果矩形已存在，更新范围
    if (tempRect) {
      tempRect.setBounds(bounds);
    } else {
      tempRect = L.rectangle(bounds, {color: "#0078ff", weight: 2}).addTo(map);
    }
  }

  map.on('mouseup', function() {
    if (!isDrawing) return;
    isDrawing = false;
    map.off('mousemove', onMouseMove);
    startLatLng = null;

    const bounds = tempRect.getBounds();
    const southWest = bounds.getSouthWest();
    const northEast = bounds.getNorthEast();

    const rectangle = turf.bboxPolygon([
        southWest.lng, southWest.lat,
        northEast.lng, northEast.lat
    ]);
    const area = turf.area(rectangle);
    num=area/1e6;
    document.getElementById('area-size').value = (area/1e6).toFixed(2) + ' 平方公里';
    document.getElementById('area-size').style.fontSize='14px';
    document.getElementById('area-size').style.color='#000000';
  });


*/
clearBtn.addEventListener('click', () => {
  // 清除图层
  drawnItems.forEach(layer => map.removeLayer(layer));
  drawnItems.length = 0;

  // 清除当前临时图形
  if (tempShape) {
    map.removeLayer(tempShape);
    tempShape = null;
  }

  // 清空状态
  polygonPoints = [];
  startLatLng = null;
  isDrawing = false;

  // 移除事件监听，防止残留
  map.off('mousemove', onMouseMove);
  map.off('click', onPolygonClick);
  map.off('dblclick');

  // 重置模式
});
  /*
  clearBtn.addEventListener('click', () => {
    if (tempRect) {
      map.removeLayer(tempRect);
      tempRect = null;
    }
  });*/


        /*
        // 绘制工具相关变量
        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        let drawControl;
        let currentDrawMode = 'rectangle';
        
        // 初始化绘制控制
        function initDrawControl() {
            // 简化版绘制控制 - 实际应用中可以使用Leaflet.draw插件
            map.on('click', function(e) {
                if (currentDrawMode === 'rectangle') {
                    // 简化版矩形绘制
                    const bounds = [
                        [e.latlng.lat - 0.005, e.latlng.lng - 0.005],
                        [e.latlng.lat + 0.005, e.latlng.lng + 0.005]
                    ];
                    const rectangle = L.rectangle(bounds, {color: "#4dabf7", weight: 2});
                    drawnItems.addLayer(rectangle);
                    updateAreaSize(rectangle);
                }
            });
        }
        
        // 更新区域面积显示
        function updateAreaSize(layer) {
            let area = 0;
            if (layer instanceof L.Rectangle) {
                const bounds = layer.getBounds();
                area = (bounds.getNorth() - bounds.getSouth()) * (bounds.getEast() - bounds.getWest()) * 111 * 111; // 简化计算
            }
            document.getElementById('area-size').value = area.toFixed(2) + ' 平方公里';
        }
        */
        // 模式选择交互
        document.querySelectorAll('.mode-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
            });
        });
        /*
        // 绘制模式切换
        document.getElementById('draw-rectangle').addEventListener('click', function() {
            setActiveDrawButton('draw-rectangle');
            currentDrawMode = 'rectangle';
        });
        
        document.getElementById('draw-polygon').addEventListener('click', function() {
            setActiveDrawButton('draw-polygon');
            currentDrawMode = 'polygon';
        });
        
        document.getElementById('draw-circle').addEventListener('click', function() {
            setActiveDrawButton('draw-circle');
            currentDrawMode = 'circle';
        });
        
        document.getElementById('clear-all').addEventListener('click', function() {
            drawnItems.clearLayers();
            document.getElementById('area-size').value = '';
        });
        
        function setActiveDrawButton(buttonId) {
            document.querySelectorAll('.map-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(buttonId).classList.add('active');
        }
        */

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min
        }
        // 生成航线按钮
        document.getElementById('generate-btn').addEventListener('click', function() {
            // 模拟生成航线后的输出
            if (!tempShape&&polygonPoints.length<3) {
                alert('请先在地图上框选任务区域');
                return;
            }
            
            const selectedMode = document.querySelector('.mode-option.selected');
            if (!selectedMode) {
                alert('请选择航线模式');
                return;
            }
            
            // 更新任务报告
            document.querySelectorAll('.task-report .value').forEach((el, index) => {
                const values = [`${Math.floor(randomInRange(10, 60))}分钟`,
                 `${randomInRange(1, 5).toFixed(1)}公里`, 
                 `${Math.floor(randomInRange(100, 200))}张`, 
                 `${randomInRange(num/3,num).toFixed(2)}平方公里`, 
                 `${Math.floor(randomInRange(50, 200))}米`];
                el.textContent = values[index];
            });
            
            alert('航线生成成功！请在右侧面板查看输出结果。');
        });
        
        
        // 初始化
        //initDrawControl();
        
        // 设置默认选择的模式
        document.querySelector('.mode-option[data-mode="1"]').click();
    </script>
</body>
</html>